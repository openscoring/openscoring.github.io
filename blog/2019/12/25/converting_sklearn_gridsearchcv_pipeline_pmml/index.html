<!DOCTYPE html>
<html lang=" en-US">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="format-detection" content="telephone=no">
  <meta name="theme-color" content="#ffffff" />
  <meta name="msapplication-navbutton-color" content="#ffffff">
  <meta name="apple-mobile-web-app-status-bar-style" content="#ffffff">

  <meta name="description" content="">
  <meta name="keywords" content="scikit-learn sklearn2pmml">
  <meta name="author" content="vruusmann">

  <title>Converting Scikit-Learn hyperparameter-tuned pipelines to PMML documents - Openscoring</title>

  <meta name="robots" content="index, follow, max-snippet:-1, max-video-preview:-1, max-image-preview:large" />
  <link rel="canonical" href="https://openscoring.io/blog/2019/12/25/converting_sklearn_gridsearchcv_pipeline_pmml/" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Converting Scikit-Learn hyperparameter-tuned pipelines to PMML documents - Openscoring" />
  <meta property="og:url" content="/blog/2019/12/25/converting_sklearn_gridsearchcv_pipeline_pmml/" />
  <meta property="og:site_name" content="Openscoring" />
  <meta property="og:updated_time" content="2019-12-25 00:00:00 +0200" />
  <meta property="article:published_time" content="2019-12-25 00:00:00 +0200" />
  <meta property="article:modified_time" content="2019-12-25 00:00:00 +0200" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Converting Scikit-Learn hyperparameter-tuned pipelines to PMML documents - Openscoring" />
  <meta name="twitter:label1" content="Written by" />
  <meta name="twitter:data1" content="Villu Ruusmann" />
  <meta name="twitter:label2" content="Time to read" />
  <meta name="twitter:data2" content="Less than a minute" />

  <link rel='dns-prefetch' href='http://fonts.googleapis.com/' />
  <link rel='dns-prefetch' href='http://s.w.org/' />
  <link rel='stylesheet' href='https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&amp;display=swap' type='text/css' media='all' />
  <script type='text/javascript' src='/assets/js/jquery/jquery.min.js?ver=3.6.0' defer></script>
  <script type='text/javascript' src='/assets/js/jquery/jquery-migrate.min.js?ver=3.3.2' defer></script>
  <link rel="icon" href="/assets/images/fa-150x150.png" sizes="32x32" />
  <link rel="icon" href="/assets/images/fa.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="/assets/images/fa.png" />
  <link rel="stylesheet" href="/assets/css/main.css">
  <meta name="msapplication-TileImage" content="h/assets/images/fa.png" />
  <!--[if lt IE 9]>
  	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>

<body>
  <header class="c-head">
  <div class="c-head__container container-p0">
    <a class="c-head__logo" href="/"><img src="/assets/images/logo.svg" alt="" /></a>
    <nav class="c-head__nav">
      <ul id="menu-main-menu" class="c-head__menu">
        <li><a href="/" aria-current="page">Home</a></li>
        <li><a href="/blog/">Blog</a></li>
        <li><a href="/#products" aria-current="page">Products</a></li>
        <li><a href="/#licensing" aria-current="page">Licensing</a></li>
        <li><a href="/#consulting" aria-current="page">Consulting</a></li>
      </ul>
    </nav>
    <button id="menu-toggle" class="c-head__toggle c-toggle" type="button">
      <span class="c-toggle__line c-toggle__top"></span>
      <span class="c-toggle__line c-toggle__mid"></span>
      <span class="c-toggle__line c-toggle__bot"></span>
    </button>
  </div>
</header>

  <div class="single-post">
  <div class="c-entry-header bg-b bg-b--cover">
    <h1 class="c-entry-header__title h3 container-p0">Converting Scikit-Learn hyperparameter-tuned pipelines to PMML documents</h1>
  </div>
  
  <main class="gb-content">
    <p>The behaviour of Scikit-Learn estimators is controlled using hyperparameters.
Feature transformers and selectors perform deterministic computations that take a very limited number of very transparent hyperparameters.
In contrast, models perform non-deterministic computations (numerical optimization) that take a much larger number of rather obscure hyperparameters.
Some of them control the complexity of the learned model object, whereas some others control the quality and speed of the learning process itself.</p>

<p>Scikit-Learn estimators assign reasonable default values to hyperparameters in their constructors.
This facilitates prototyping work, where the goal is to establish the structure of a pipeline by quickly adding or modifying steps.
However, the default configuration is hardly ever the optimal one.</p>

<p>There is no analytic procedure for determining the best configuration from scratch, or even comparing two configurations goodness-wise.
In practice, the most common way of finding a good configuration is to generate many configurations, and rank them on the basis of their predictive performance on a testing dataset.</p>

<p>The <a href="https://scikit-learn.org/stable/modules/classes.html#module-sklearn.model_selection">Model Selection</a> module provides meta-estimators and utility functions for developing robust solutions in this area.</p>

<p>In brief, a data scientist defines the template pipeline and the associated hyperparameter space.
The latter is a mapping between parameter names and parameter value ranges (a list of preselected values, or a distribution function).
If the dimensionality of the hyperparameter space is low, and the gradation of all individual dimensions is directly enumerable, then it is possible to perform exhaustive search using the <code class="language-plaintext highlighter-rouge">GridSearchCV</code> meta-estimator.
In all other cases, it is possible to perform random sampling using the <code class="language-plaintext highlighter-rouge">RandomizedSearchCV</code> meta-estimator.</p>

<h3 id="single-estimator-aka-local-tuning">Single estimator (aka local) tuning</h3>

<p>If the pipeline contains just one tuneable estimator, then the tuning work should be performed locally, by wrapping this estimator in its current place into a search meta-estimator:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn_pandas</span> <span class="kn">import</span> <span class="n">DataFrameMapper</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelBinarizer</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn2pmml</span> <span class="kn">import</span> <span class="n">sklearn2pmml</span>
<span class="kn">from</span> <span class="nn">sklearn2pmml.decoration</span> <span class="kn">import</span> <span class="n">CategoricalDomain</span><span class="p">,</span> <span class="n">ContinuousDomain</span>
<span class="kn">from</span> <span class="nn">sklearn2pmml.pipeline</span> <span class="kn">import</span> <span class="n">PMMLPipeline</span>

<span class="n">mapper</span> <span class="o">=</span> <span class="n">DataFrameMapper</span><span class="p">(</span>
  <span class="p">[(</span><span class="n">cat_column</span><span class="p">,</span> <span class="p">[</span><span class="n">CategoricalDomain</span><span class="p">(),</span> <span class="n">LabelBinarizer</span><span class="p">()])</span> <span class="k">for</span> <span class="n">cat_column</span> <span class="ow">in</span> <span class="n">cat_columns</span><span class="p">]</span> <span class="o">+</span>
  <span class="p">[([</span><span class="n">cont_column</span><span class="p">],</span> <span class="p">[</span><span class="n">ContinuousDomain</span><span class="p">(),</span> <span class="n">StandardScaler</span><span class="p">()])</span> <span class="k">for</span> <span class="n">cont_column</span> <span class="ow">in</span> <span class="n">cont_columns</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">classifier</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">multi_class</span> <span class="o">=</span> <span class="s">"ovr"</span><span class="p">,</span> <span class="n">penalty</span> <span class="o">=</span> <span class="s">"elasticnet"</span><span class="p">,</span> <span class="n">solver</span> <span class="o">=</span> <span class="s">"saga"</span><span class="p">,</span> <span class="n">max_iter</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s">"l1_ratio"</span> <span class="p">:</span> <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">pipeline</span> <span class="o">=</span> <span class="n">PMMLPipeline</span><span class="p">([</span>
  <span class="p">(</span><span class="s">"mapper"</span><span class="p">,</span> <span class="n">mapper</span><span class="p">),</span>
  <span class="p">(</span><span class="s">"classifier"</span><span class="p">,</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span> <span class="o">=</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">param_grid</span> <span class="o">=</span> <span class="n">param_grid</span><span class="p">))</span>
<span class="p">])</span>
<span class="n">pipeline</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_X</span><span class="p">,</span> <span class="n">df_y</span><span class="p">)</span>
<span class="n">pipeline</span><span class="p">.</span><span class="n">verify</span><span class="p">(</span><span class="n">df_X</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">sklearn2pmml</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s">"GridSearchAudit.pmml"</span><span class="p">)</span>
</code></pre></div></div>

<p>Both <code class="language-plaintext highlighter-rouge">GridSearchCV</code> and <code class="language-plaintext highlighter-rouge">RandomizedSearchCV</code> meta-estimators split the original dataset into training and validation subsets.
As a result, the fit method of the tuneable estimator is exposed to less data records than the fit methods of all the other estimators in the pipeline.
For example, in the above Python code, the <code class="language-plaintext highlighter-rouge">LogisticRegression.fit(X, y)</code> method is called with roughly 80% of data records (the training subset of the original dataset), whereas <code class="language-plaintext highlighter-rouge">LabelBinarizer.fit(X)</code> and <code class="language-plaintext highlighter-rouge">StandardScaler.fit(X)</code> methods are called with 100% of data records (full original dataset).
Data scientists may want to compensate for this effect, especially when working with smaller and more heterogeneous datasets.</p>

<h3 id="pipeline-aka-global-tuning">Pipeline (aka global) tuning</h3>

<p>If the pipeline contains multiple tuneable estimators, then the tuning work should be performed globally, by wrapping the complete pipeline into a search meta-estimator:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.feature_selection</span> <span class="kn">import</span> <span class="n">SelectKBest</span>

<span class="n">mapper</span> <span class="o">=</span> <span class="n">DataFrameMapper</span><span class="p">(</span>
  <span class="p">[(</span><span class="n">cat_column</span><span class="p">,</span> <span class="p">[</span><span class="n">CategoricalDomain</span><span class="p">(</span><span class="n">invalid_value_treatment</span> <span class="o">=</span> <span class="s">"as_is"</span><span class="p">),</span> <span class="n">LabelBinarizer</span><span class="p">()])</span> <span class="k">for</span> <span class="n">cat_column</span> <span class="ow">in</span> <span class="n">cat_columns</span><span class="p">]</span> <span class="o">+</span>
  <span class="p">[([</span><span class="n">cont_column</span><span class="p">],</span> <span class="p">[</span><span class="n">ContinuousDomain</span><span class="p">(</span><span class="n">invalid_value_treatment</span> <span class="o">=</span> <span class="s">"as_is"</span><span class="p">),</span> <span class="n">StandardScaler</span><span class="p">()])</span> <span class="k">for</span> <span class="n">cont_column</span> <span class="ow">in</span> <span class="n">cont_columns</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">selector</span> <span class="o">=</span> <span class="n">SelectKBest</span><span class="p">()</span>

<span class="n">classifier</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">multi_class</span> <span class="o">=</span> <span class="s">"ovr"</span><span class="p">,</span> <span class="n">penalty</span> <span class="o">=</span> <span class="s">"elasticnet"</span><span class="p">,</span> <span class="n">solver</span> <span class="o">=</span> <span class="s">"saga"</span><span class="p">,</span> <span class="n">max_iter</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">pipeline</span> <span class="o">=</span> <span class="n">PMMLPipeline</span><span class="p">([</span>
  <span class="p">(</span><span class="s">"mapper"</span><span class="p">,</span> <span class="n">mapper</span><span class="p">),</span>
  <span class="p">(</span><span class="s">"selector"</span><span class="p">,</span> <span class="n">selector</span><span class="p">),</span>
  <span class="p">(</span><span class="s">"classifier"</span><span class="p">,</span> <span class="n">classifier</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s">"selector__k"</span> <span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span>
  <span class="s">"classifier__l1_ratio"</span> <span class="p">:</span> <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">searcher</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">,</span> <span class="n">param_grid</span> <span class="o">=</span> <span class="n">param_grid</span><span class="p">)</span>
<span class="n">searcher</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_X</span><span class="p">,</span> <span class="n">df_y</span><span class="p">)</span>

<span class="n">best_pipeline</span> <span class="o">=</span> <span class="n">searcher</span><span class="p">.</span><span class="n">best_estimator_</span>
<span class="n">best_pipeline</span><span class="p">.</span><span class="n">verify</span><span class="p">(</span><span class="n">df_X</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">sklearn2pmml</span><span class="p">(</span><span class="n">best_pipeline</span><span class="p">,</span> <span class="s">"GridSearchAudit.pmml"</span><span class="p">)</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">GridSearchCV</code> meta-estimator can be regarded as a workflow execution engine.
It takes a template pipeline, performs the search, and returns a hyperparameter-tuned clone of this template pipeline as a <code class="language-plaintext highlighter-rouge">best_estimator_</code> attribute.</p>

<p>All hyperparameter spaces are collected into a single map.
They are kept separate from one another logically by prefixing parameter names with the step identifier.</p>

<p>The search meta-estimator is still splitting the original dataset into two subsets.
However, the split happens before the workflow execution enters the <code class="language-plaintext highlighter-rouge">(PMML)Pipeline.fit(X, y)</code> method, so all estimators in the pipeline are exposed to the same number of data records.</p>

<p>If the span of a validation subset exceeds that of a training subset, then the corresponding cross-validation fold fails with a value error:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Traceback (most recent call last):
  File "train-global.py", line 41, in &lt;module&gt;
    searcher.fit(df_X, df_y)
  File "/usr/local/lib/python3.7/site-packages/sklearn/model_selection/_search.py", line 712, in fit
    self._run_search(evaluate_candidates)
  File "/usr/local/lib/python3.7/site-packages/sklearn/model_selection/_search.py", line 1153, in _run_search
    evaluate_candidates(ParameterGrid(self.param_grid))
  File "/usr/local/lib/python3.7/site-packages/sklearn/model_selection/_search.py", line 691, in evaluate_candidates
    cv.split(X, y, groups)))
  ...
  File "/usr/local/lib/python3.7/site-packages/sklearn/pipeline.py", line 613, in score
    Xt = transform.transform(Xt)
  File "/usr/local/lib/python3.7/site-packages/sklearn_pandas/dataframe_mapper.py", line 377, in transform
    return self._transform(X)
  File "/usr/local/lib/python3.7/site-packages/sklearn_pandas/dataframe_mapper.py", line 306, in _transform
    Xt = transformers.transform(Xt)
  File "/usr/local/lib/python3.7/site-packages/sklearn/pipeline.py", line 555, in _transform
    Xt = transform.transform(Xt)
  File "/usr/local/lib/python3.7/site-packages/sklearn2pmml/decoration/__init__.py", line 119, in transform
    self._transform_invalid_values(X, invalid_value_mask)
  File "/usr/local/lib/python3.7/site-packages/sklearn2pmml/decoration/__init__.py", line 103, in _transform_invalid_values
    raise ValueError("Data contains {0} invalid values".format(numpy.count_nonzero(where)))
ValueError: Employment: Data contains 1 invalid values
</code></pre></div></div>

<p>It is possible to suppress this sanity check by changing the value of the <code class="language-plaintext highlighter-rouge">Domain.invalid_value_treatment</code> attribute from <code class="language-plaintext highlighter-rouge">return_invalid</code> to <code class="language-plaintext highlighter-rouge">as_is</code>.</p>

<h3 id="resources">Resources</h3>

<ul>
  <li>“Audit” dataset: <a href="https://openscoring.io/resources/data/audit.csv"><code class="language-plaintext highlighter-rouge">audit.csv</code></a></li>
  <li>Python scripts: <a href="https://openscoring.io/resources/2019-12-25/train-local.py"><code class="language-plaintext highlighter-rouge">train-local.py</code></a> and <a href="https://openscoring.io/resources/2019-12-25/train-global.py"><code class="language-plaintext highlighter-rouge">train-global.py</code></a></li>
</ul>

  </main>
</div>



  <footer class="c-footer bg-primary">
  <div class="c-footer__container container">
    <a class="c-footer__logo" href="index.html"><img src="/assets/images/logo-w.svg" alt="" /></a>
    <div class="c-footer__info">
      <div class="c-footer__text">© 2022 - Openscoring.io</div>
    </div><a class="c-footer__social" href="https://twitter.com/openscoring" target="_blank">
      Follow Openscoring on Twitter
    </a>
  </div>
</footer>

  <script>
    var sc_project = 11704106;
    var sc_security = "a7d1bf16";
    var sc_invisible = 1;
    var scJsHost = (("https:" == document.location.protocol) ?
      "https://secure." : "http://www.");
  </script>

  <script type="text/javascript" src="https://secure.statcounter.com/counter/counter.js" async=""></script>

  <noscript>
    <div class="statcounter">
      <a title="web analytics" href="https://statcounter.com/">
        <img class="statcounter" src="https://c.statcounter.com/11704106/0/a7d1bf16/1/" alt="web analytics" />
      </a>
    </div>
  </noscript>

  <script type="text/javascript" src="/assets/js/bootstrap.bundle.min.js" defer></script>
  <script type="text/javascript" src="/assets/js/swiper/swiper.min.js" defer></script>
  <script type="text/javascript" src="/assets/js/functions.js" defer></script>
</body>

</html>